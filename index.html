<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward App</title>

    <script src='//libtl.com/sdk.js' data-zone='10073859' data-sdk='show_10073859'></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --color-background: #121212;
            --color-card: #1e1e1e;
            --color-border: #374151;
            --color-accent: #f97316;
            --color-accent-hover: #ea580c;
            --color-text-primary: #e5e7eb;
            --color-text-secondary: #9ca3af;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--color-background); color: var(--color-text-primary); }
        .card-bg { background-color: var(--color-card); border: 1px solid var(--color-border); }
        .accent-gradient { background-image: linear-gradient(to right, #fb923c, var(--color-accent)); }
        .text-accent { color: var(--color-accent); }
        .btn-accent { background-color: var(--color-accent); color: #ffffff; font-weight: 600; transition: background-color 0.2s ease; }
        .btn-accent:hover { background-color: var(--color-accent-hover); }
        .btn-outline-accent { border: 1px solid var(--color-accent); color: var(--color-accent); font-weight: 600; transition: all 0.2s ease; }
        .btn-outline-accent:hover { background-color: var(--color-accent); color: #ffffff; }
        .btn-accent:disabled, .btn-outline-accent:disabled { background-color: #4b5563; border-color: #4b5563; color: #9ca3af; cursor: not-allowed; }
        .input-field { background-color: #2c2c2c; border: 1px solid #444; color: var(--color-text-primary); }
        .input-field:focus { border-color: var(--color-accent); outline: none; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.5); }
        
        .main-page { display: none; }
        .main-page.active { display: flex; animation: fadeInMain 0.3s ease-in-out; }
        .sub-page { display: none; }
        .sub-page.active { display: block; animation: fadeInPage 0.3s ease-in-out; }
        @keyframes fadeInMain { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Page Header for immersive pages --- */
        .page-header { display: flex; align-items: center; padding: 1rem; position: relative; justify-content: center; }
        .back-button { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: var(--color-card); border: 1px solid var(--color-border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .back-button:hover { background-color: var(--color-border); }
        
        /* --- Professional Bottom Navigation --- */
        .bottom-nav { background-color: var(--color-card); border-top: 1px solid var(--color-border); padding: 8px 0; transition: transform 0.3s ease-in-out; }
        .bottom-nav.hidden { transform: translateY(100%); }
        .bottom-nav a { color: var(--color-text-secondary); transition: color 0.2s ease; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; padding: 4px 0; }
        .bottom-nav a .nav-text { font-size: 11px; font-weight: 500; }
        .bottom-nav a.active { color: var(--color-accent); }
        .bottom-nav a::before { content: ''; position: absolute; top: -2px; width: 30px; height: 4px; background-color: var(--color-accent); border-radius: 2px; transform: scaleX(0); transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .bottom-nav a.active::before { transform: scaleX(1); }
        
        /* General UI Styles */
        .section-header { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        
        /* Spin Wheel Styles */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 2rem auto; }
        .wheel-wrapper { background: var(--color-card); border-radius: 50%; padding: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.7); }
        .wheel { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .wheel-svg text { font-size: 18px; font-weight: 700; fill: #ffffff; text-anchor: middle; dominant-baseline: middle; }
        .wheel-pointer { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid var(--color-accent); z-index: 10; filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));}
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: var(--color-background); border-radius: 50%; z-index: 10; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(249, 115, 22, 0.5); }

        /* Wallet Page Styles */
        .payment-method-card { background-color: #2c2c2c; border: 2px solid #444; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .payment-method-card:hover { background-color: var(--color-border); }
        .payment-method-card.selected { border-color: var(--color-accent); background-color: rgba(249, 115, 22, 0.1); box-shadow: 0 0 10px rgba(249, 115, 22, 0.5); }
    </style>
</head>
<body class="max-w-md mx-auto">

<div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2" style="border-color: var(--color-accent);"></div>
</div>

<div id="app-container" class="min-h-screen flex-col main-page">
    <header id="main-header" class="flex items-center justify-between p-4 sticky top-0 bg-black/60 backdrop-blur-md z-10">
        <div>
            <p class="text-xs text-gray-400">Welcome back!</p>
            <h1 class="text-xl font-bold text-white" id="header-user-name">User</h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="notification-bell" class="relative cursor-pointer">
                <i data-lucide="bell" class="w-6 h-6"></i>
                <div class="notification-dot absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-black/60 hidden"></div>
            </div>
        </div>
    </header>

    <main class="flex-grow">
        <div id="home-page" class="p-4 space-y-6 sub-page">
            <div class="accent-gradient p-5 rounded-xl text-white shadow-lg flex justify-between items-center">
                <div><p class="text-sm font-medium opacity-80">Your Balance</p><p class="text-4xl font-extrabold tracking-tight"><span id="coin-balance">0</span></p></div>
                <div class="bg-white/20 p-3 rounded-full"><i data-lucide="wallet" class="w-7 h-7"></i></div>
            </div>
            
            <section><h2 class="section-header">Mini Games</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="card-bg rounded-lg p-4 text-center cursor-pointer transition-transform duration-200 hover:scale-105" onclick="navigateTo('spin-page')"><i data-lucide="rotate-cw" class="w-8 h-8 text-accent mx-auto mb-2"></i><h3 class="font-semibold text-white">Spin to Earn</h3><p class="text-xs text-gray-400 mt-1">Win up to 1000 Taka</p></div>
                    <div class="card-bg rounded-lg p-4 text-center cursor-pointer transition-transform duration-200 hover:scale-105" onclick="navigateTo('visit-page')"><i data-lucide="mouse-pointer-click" class="w-8 h-8 text-accent mx-auto mb-2"></i><h3 class="font-semibold text-white">Visit & Earn</h3><p class="text-xs text-gray-400 mt-1">Complete tasks</p></div>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4"><h2 class="section-header mb-0">Daily Tasks</h2><p class="text-sm text-gray-400">Ads Left: <span id="ads-left-count">...</span></p></div>
                <div class="space-y-3">
                    <div class="card-bg p-3 rounded-lg flex items-center justify-between"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-full"><i data-lucide="video" class="w-6 h-6 text-accent"></i></div><div><h3 class="font-semibold text-white">Watch Short Ad</h3><p class="text-xs text-gray-400">Rewarded Interstitial</p></div></div><button class="btn-outline-accent font-bold px-4 py-1.5 rounded-lg text-sm" onclick="claimReward('interstitial')">Claim</button></div>
                    <div class="card-bg p-3 rounded-lg flex items-center justify-between"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-full"><i data-lucide="mouse-pointer" class="w-6 h-6 text-accent"></i></div><div><h3 class="font-semibold text-white">Click for Reward</h3><p class="text-xs text-gray-400">Rewarded Popup</p></div></div><button class="btn-outline-accent font-bold px-4 py-1.5 rounded-lg text-sm" onclick="claimReward('popup')">Claim</button></div>
                    <div class="card-bg p-3 rounded-lg flex items-center justify-between"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-full"><i data-lucide="play-circle" class="w-6 h-6 text-accent"></i></div><div><h3 class="font-semibold text-white">Watch a Video</h3><p class="text-xs text-gray-400">In-App Interstitial</p></div></div><button class="btn-outline-accent font-bold px-4 py-1.5 rounded-lg text-sm" onclick="claimReward('inApp')">Start</button></div>
                    <div class="card-bg p-3 rounded-lg flex items-center justify-between"><div class="flex items-center space-x-3"><div class="p-2 bg-orange-500/20 rounded-full"><i data-lucide="gamepad-2" class="w-6 h-6 text-accent"></i></div><div><h3 class="font-semibold text-white">Play Mini App</h3><p class="text-xs text-gray-400">Get a big reward!</p></div></div><button class="btn-outline-accent font-bold px-4 py-1.5 rounded-lg text-sm" onclick="claimReward('miniApp')">Play</button></div>
                </div>
            </section>
        </div>

        <div id="spin-page" class="sub-page immersive-page">
            <div class="page-header"><button class="back-button" onclick="navigateTo('home-page')"><i data-lucide="chevron-left" class="text-white"></i></button><h2 class="section-header text-center m-0">Spin to Earn</h2></div>
            <div class="p-4 text-center">
                <p class="text-gray-400 -mt-4 mb-4">Test your luck and win big!</p>
                <div class="wheel-container"><div class="wheel-wrapper"><div class="wheel" id="wheel"><svg id="spin-wheel-svg" class="wheel-svg" viewBox="0 0 200 200"></svg></div></div><div class="wheel-pointer"></div><div class="wheel-center"><i data-lucide="star" class="w-6 h-6 text-accent"></i></div></div>
                <div class="card-bg p-4 rounded-lg mt-6"><p id="spin-result" class="text-lg font-semibold h-7">Spin the wheel to win!</p></div>
                <div class="flex justify-center space-x-4 mt-4"><button id="free-spin-btn" class="w-full p-3 rounded-lg btn-accent flex items-center justify-center gap-2"><i data-lucide="gift"></i>Free Spin</button><button id="ad-spin-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-center gap-2"><i data-lucide="video"></i>Watch Ad & Spin</button></div>
                <p id="next-free-spin" class="text-sm text-gray-400 mt-2">Next free spin in: <span id="free-spin-timer" class="font-semibold text-white">00:00:00</span></p>
                <p id="ad-spins-left-text" class="text-sm text-gray-400 mt-2">Ad spins left: <span id="ad-spins-left" class="font-semibold text-white">...</span></p>
            </div>
        </div>

        <div id="visit-page" class="sub-page immersive-page">
            <div class="page-header"><button class="back-button" onclick="navigateTo('home-page')"><i data-lucide="chevron-left" class="text-white"></i></button><h2 class="section-header text-center m-0">Visit & Earn</h2></div>
            <div id="visit-tasks-list" class="p-4 space-y-3">
                </div>
        </div>
        
        <div id="wallet-page" class="p-4 space-y-6 sub-page">
            <h2 class="section-header text-center">My Wallet</h2>
            <div class="accent-gradient p-6 rounded-xl text-white shadow-lg text-center"><p class="text-sm opacity-80">Current Balance</p><p class="text-4xl font-bold mt-1"><span id="wallet-coin-balance">0</span></p><p class="text-xs opacity-80 mt-2" id="coin-value-info" style="display: none;">...</p></div>
            <div class="card-bg p-4 rounded-lg">
                <h3 class="font-semibold mb-4 text-lg text-white">1. Select Payment Method</h3><div id="payment-method-grid" class="grid grid-cols-2 gap-3 mb-4"></div>
                <h3 class="font-semibold mb-2 text-lg text-white">2. Enter Details</h3><div class="space-y-3"><input id="withdraw-amount" type="number" placeholder="Enter Amount (৳)" class="w-full p-3 rounded-lg input-field"><div id="payment-details-container"></div></div>
                <p class="text-xs text-gray-400 mt-2">Minimum Withdrawal: <span class="font-bold text-accent" id="min-withdrawal-info">...</span></p>
                
                <p class="text-xs text-gray-400 mt-1">Your Referrals: <span class="font-bold text-accent" id="user-referral-count">...</span></p>
                
                <button id="withdraw-btn" class="w-full p-3 rounded-lg btn-accent mt-4">Request Withdrawal</button>
            </div>
            <div><h3 class="section-header">Withdrawal History</h3><div id="withdrawal-history-list" class="space-y-3"></div></div>
        </div>

        <div id="refer-page" class="p-4 space-y-6 sub-page">
             <h2 class="section-header text-center">Refer & Earn</h2>
             <div class="card-bg p-6 rounded-lg text-center">
                 <i data-lucide="gift" class="w-12 h-12 mx-auto text-accent"></i>
                 <h3 class="text-xl font-bold mt-3 text-white">Invite a Friend</h3>
                 <p id="referral-bonus-text" class="text-gray-300 mt-1">Share your link. You both get <span class="text-accent font-bold">৳100</span> as a bonus!</p>
                 
                 <div class="flex gap-2 mt-6">
                    <button id="copy-link-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-center gap-2">
                        <i data-lucide="copy"></i>Copy Link
                    </button>
                    <button id="share-link-btn" class="w-full p-3 rounded-lg btn-accent flex items-center justify-center gap-2">
                        <i data-lucide="share-2"></i>Share Link
                    </button>
                </div>

                <div class="mt-8 text-left">
                    <h3 class="font-semibold text-lg text-white mb-3">Referral Rules</h3>
                    <div id="referral-rules-list" class="space-y-2">
                        </div>
                </div>
             </div>
        </div>

        <div id="profile-page" class="p-4 space-y-6 sub-page">
             <h2 class="section-header text-center">Profile</h2>
             <div class="card-bg p-6 rounded-lg flex flex-col items-center text-center"><img src="https://placehold.co/100x100/1e1e1e/f97316?text=U" class="rounded-full mb-3 border-4 border-gray-700"><h2 id="profile-name" class="text-2xl font-bold text-white">User Name</h2><p id="profile-email" class="text-gray-300">user@email.com</p></div>
             <div class="grid grid-cols-2 gap-4">
                 <div class="card-bg p-4 rounded-lg text-center"><i data-lucide="coins" class="w-7 h-7 mx-auto text-accent mb-1"></i><p class="text-xl font-bold text-white" id="profile-total-earned">0</p><p class="text-xs text-gray-400">Total Earned</p></div>
                 <div class="card-bg p-4 rounded-lg text-center"><i data-lucide="check-circle" class="w-7 h-7 mx-auto text-accent mb-1"></i><p class="text-xl font-bold text-white" id="profile-tasks-completed">0</p><p class="text-xs text-gray-400">Tasks Completed</p></div>
                 <div class="card-bg p-4 rounded-lg text-center"><i data-lucide="calendar" class="w-7 h-7 mx-auto text-accent mb-1"></i><p class="text-xl font-bold text-white" id="profile-days-active">1</p><p class="text-xs text-gray-400">Days Active</p></div>
                 <div class="card-bg p-4 rounded-lg text-center"><i data-lucide="users" class="w-7 h-7 mx-auto text-accent mb-1"></i><p class="text-xl font-bold text-white" id="profile-referrals">0</p><p class="text-xs text-gray-400">Referrals</p></div>
             </div>
             <div class="card-bg rounded-lg mt-4"><a href="#" class="w-full text-left p-4 flex items-center justify-between border-b border-gray-700 hover:bg-gray-700/50 rounded-t-lg"><span class="font-semibold text-white">Notification Settings</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a><a href="#" class="w-full text-left p-4 flex items-center justify-between border-b border-gray-700 hover:bg-gray-700/50"><span class="font-semibold text-white">Privacy Policy</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a><a href="#" class="w-full text-left p-4 flex items-center justify-between border-b border-gray-700 hover:bg-gray-700/50"><span class="font-semibold text-white">Terms of Service</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a><a href="#" class="w-full text-left p-4 flex items-center justify-between hover:bg-gray-700/50 rounded-b-lg"><span class="font-semibold text-white">Help & Support</span><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></a></div>
             </div>
        
        <div id="notifications-page" class="sub-page immersive-page">
            <div class="page-header"><button class="back-button" onclick="navigateTo('home-page')"><i data-lucide="chevron-left" class="text-white"></i></button><h2 class="section-header text-center m-0">Notifications</h2></div>
            <div id="notifications-list" class="p-4 space-y-3"></div>
        </div>
    </main>

    <nav id="bottom-nav" class="bottom-nav sticky bottom-0 grid grid-cols-4 items-center text-center mt-4">
        <a href="#" class="nav-link" data-page="home-page"><i data-lucide="home" class="mx-auto w-6 h-6"></i><span class="nav-text">Home</span></a>
        <a href="#" class="nav-link" data-page="wallet-page"><i data-lucide="wallet" class="mx-auto w-6 h-6"></i><span class="nav-text">Wallet</span></a>
        <a href="#" class="nav-link" data-page="refer-page"><i data-lucide="users" class="mx-auto w-6 h-6"></i><span class="nav-text">Refer</span></a>
        <a href="#" class="nav-link" data-page="profile-page"><i data-lucide="user" class="mx-auto w-6 h-6"></i><span class="nav-text">Profile</span></a>
    </nav>
</div>

<div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center border border-gray-700 shadow-xl"><p id="alert-message" class="mb-6 text-white"></p><button id="alert-ok-btn" class="btn-accent px-8 py-2 rounded-lg">OK</button></div></div>

<div id="welcome-dialog" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="card-bg rounded-lg p-6 w-full max-w-md shadow-xl border border-gray-700">
        <h2 id="welcome-title-text" class="text-2xl font-bold text-center mb-4 text-white"></h2>
        <div class="text-sm text-gray-300 mb-6" style="white-space: pre-wrap; max-height: 40vh; overflow-y: auto;">
            <p id="welcome-message-text"></p>
        </div>
        <div class="flex gap-4">
            <button id="welcome-later-btn" class="w-1/2 btn-outline-accent px-6 py-2 rounded-lg font-semibold">পরে দেখবো</button>
            <button id="welcome-ok-btn" class="w-1/2 btn-accent px-6 py-2 rounded-lg font-semibold">বুঝেছি</button>
        </div>
    </div>
</div>

<script type="module">
    // --- Firebase Initialization ---
    const firebaseConfig = {
        apiKey: "AIzaSyBDotOOjNOn-ocA5PCJ0qk28DR1rLxB4vo",
        authDomain: "philadelphia-955e1.firebaseapp.com",
        databaseURL: "https://philadelphia-955e1-default-rtdb.firebaseio.com",
        projectId: "philadelphia-955e1",
        storageBucket: "philadelphia-955e1.firebasestorage.app",
        messagingSenderId: "462560675425",
        appId: "1:462560675425:web:ea4cb61b2b26ddf30e8c20",
        measurementId: "G-YS0H89Q868"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let userData = null;
    let appConfig = {};
    let selectedPaymentMethod = null;

    // --- DOM Element Cache ---
    const elementCache = {
        loader: document.getElementById('loader'),
        mainHeader: document.getElementById('main-header'),
        bottomNav: document.getElementById('bottom-nav'),
        coinBalance: document.getElementById('coin-balance'),
        walletCoinBalance: document.getElementById('wallet-coin-balance'),
        profileName: document.getElementById('profile-name'),
        profileEmail: document.getElementById('profile-email'),
        headerUserName: document.getElementById('header-user-name'),
        minWithdrawalInfo: document.getElementById('min-withdrawal-info'),
        coinValueInfo: document.getElementById('coin-value-info'),
        notificationDot: document.querySelector('.notification-dot'),
        adsLeftCount: document.getElementById('ads-left-count'),
        paymentDetailsContainer: document.getElementById('payment-details-container'),
        paymentMethodGrid: document.getElementById('payment-method-grid'),
        freeSpinBtn: document.getElementById('free-spin-btn'),
        adSpinBtn: document.getElementById('ad-spin-btn'),
        spinResult: document.getElementById('spin-result'),
        freeSpinTimer: document.getElementById('free-spin-timer'),
        adSpinsLeft: document.getElementById('ad-spins-left'),
        profileTotalEarned: document.getElementById('profile-total-earned'),
        profileTasksCompleted: document.getElementById('profile-tasks-completed'),
        profileDaysActive: document.getElementById('profile-days-active'),
        profileReferrals: document.getElementById('profile-referrals'),
        referralBonusText: document.getElementById('referral-bonus-text'),
        referralRulesList: document.getElementById('referral-rules-list'),
        userReferralCount: document.getElementById('user-referral-count'),
        visitTasksList: document.getElementById('visit-tasks-list'),
    };
    
    // --- App Initialization ---
    window.onload = () => {
        lucide.createIcons(); 
        setupEventListeners();
        elementCache.loader.style.display = 'flex';
        initializeTelegramLogin();
        initializeSpinWheelSVG();
    };

    // --- Core Functions (Auth, Data Fetching) ---
    async function initializeTelegramLogin() {
        try {
            if (!window.Telegram || !window.Telegram.WebApp) {
                showAlert("Please open this app inside Telegram.");
                elementCache.loader.style.display = 'none';
                return;
            }

            window.Telegram.WebApp.ready();
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            
            const referrerId = window.Telegram.WebApp.initDataUnsafe.start_param || null;

            if (!tgUser) {
                showAlert("Could not retrieve Telegram user data.");
                elementCache.loader.style.display = 'none';
                return;
            }

            currentUser = {
                uid: tgUser.id.toString(),
                name: `${tgUser.first_name} ${tgUser.last_name || ''}`.trim(),
                email: tgUser.username ? tgUser.username : tgUser.id.toString()
            };

            await fetchAppConfig(); 
            await fetchUserData(referrerId); 

            if (userData.isBlocked) {
                showAlert("Your account has been blocked.");
                elementCache.loader.style.display = 'none';
                document.body.innerHTML = '<h1 class="text-red-500 text-center p-10">Account Blocked</h1>';
                return;
            }
            
            await checkNewNotifications();
            updateUI();
            showMainPage('app-container');
            navigateTo('home-page');
            
            // *** নতুন পরিবর্তন: ওয়েলকাম ডায়লগ চেক ***
            if ((userData.lastSeenWelcomeVersion || 0) < (appConfig.welcomeVersion || 1)) {
                showWelcomeDialog(appConfig.welcomeTitle, appConfig.welcomeMessage);
            }
            
            elementCache.loader.style.display = 'none';
            initializeSpinTimer();

        } catch (error) {
            console.error("Telegram Init Error: ", error);
            showAlert("Error initializing app.");
            elementCache.loader.style.display = 'none';
        }
    }

    async function fetchUserData(referrerId = null) {
        if (!currentUser) return;
        const userRef = doc(db, "users", currentUser.uid);
        try {
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) { 
                userData = userSnap.data(); 
                const today = new Date().toISOString().split('T')[0];
                const lastActive = userData.lastActiveDate || new Date(userData.createdAt.seconds * 1000).toISOString().split('T')[0];
                if (today !== lastActive) {
                    await updateDoc(userRef, {
                        daysActive: increment(1),
                        lastActiveDate: today
                    });
                    userData.daysActive = (userData.daysActive || 1) + 1;
                }
            } 
            else {
                const ownReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                
                let bonus = 15; // ডিফল্ট বোনাস এখন টাকা
                let referredBy = null;
                const bonusAmount = appConfig.referralBonus || 1; // ডিফল্ট ১ টাকা

                if (referrerId && referrerId !== currentUser.uid) {
                    bonus += bonusAmount; 
                    referredBy = referrerId;
                }
                
                const today = new Date().toISOString().split('T')[0];
                const defaultUserData = {
                    uid: currentUser.uid,
                    name: currentUser.name || 'Telegram User',
                    email: currentUser.email || currentUser.uid,
                    balance: bonus,
                    referralCode: ownReferralCode, 
                    referredBy: referredBy,
                    lastNotificationCheck: new Date(),
                    createdAt: serverTimestamp(),
                    dailyAdCount: 0,
                    lastAdWatchDate: today,
                    isBlocked: false,
                    lastFreeSpin: null,
                    scratchCardsUsed: 0,
                    lastScratchDate: today,
                    totalEarned: bonus,
                    tasksCompleted: 0,
                    daysActive: 1,
                    successfulReferrals: 0,
                    lastActiveDate: today,
                    adSpinsUsed: 0,
                    lastAdSpinDate: today,
                    completedVisitTasks: {},
                    lastSeenWelcomeVersion: 0 // *** নতুন পরিবর্তন ***
                };
                await setDoc(userRef, defaultUserData);
                userData = defaultUserData;

                if (referredBy) {
                    const referrerRef = doc(db, "users", referredBy);
                    try {
                        await updateDoc(referrerRef, { 
                            balance: increment(bonusAmount),
                            successfulReferrals: increment(1)
                        });
                    } catch (error) {
                        console.error("Failed to update referrer bonus: ", error);
                    }
                }
            }
        } catch (error) { console.error("Error fetching user data:", error); showAlert("Error loading user data."); }
    }

    async function fetchAppConfig() {
        const configRef = doc(db, "config", "main");
        const visitTasksRef = doc(db, "config", "visitTasks");
        try {
            const [configSnap, visitTasksSnap] = await Promise.all([getDoc(configRef), getDoc(visitTasksRef)]); 

            appConfig = configSnap.exists() ? configSnap.data() : {  
                minWithdrawal: 50, // এখন 50 টাকা
                paymentMethods: [ { name: "Paytm", icon: "smartphone" }, { name: "Google Pay", icon: "credit-card" }, { name: "PhonePe", icon: "zap" }, { name: "UPI", icon: "at-sign" } ], 
                dailyAdLimit: 10,  
                dailyFreeScratches: 3, 
                referralBonus: 1, // এখন 1 টাকা
                referralRules: ["Invite friends to earn!"], 
                shareText: "Join me on CashReward! {APP_LINK}", 
                minReferrals: 0,
                dailyAdSpinLimit: 5,
                rewardInterstitial: 0.5, // 0.5 টাকা
                rewardPopup: 0.5, // 0.5 টাকা
                rewardInApp: 0,
                rewardMiniApp: 1 // 1 টাকা
            };

            appConfig.visitTasks = visitTasksSnap.exists() ? visitTasksSnap.data().tasks : [];

            // *** নতুন পরিবর্তন: ওয়েলকাম ডায়লগ ডিফল্ট ***
            appConfig.welcomeTitle = appConfig.welcomeTitle || "Welcome!";
            appConfig.welcomeMessage = appConfig.welcomeMessage || "Welcome to our app. Please follow the rules.";
            appConfig.welcomeVersion = appConfig.welcomeVersion || 1;

        } catch (error) { console.error("Error fetching app config:", error); }
    }
    
    // --- UI Update & Navigation ---
    function updateUI() {
        if (!userData) return;
        const balance = userData.balance || 0;
        elementCache.coinBalance.innerHTML = `৳${balance.toLocaleString()}`;
        elementCache.walletCoinBalance.innerHTML = `৳${balance.toLocaleString()}`;
        elementCache.profileName.textContent = userData.name || 'No Name';
        elementCache.profileEmail.textContent = (userData.email || 'No Email').replace('@telegram.user', '');
        elementCache.headerUserName.textContent = userData.name || 'User';
        elementCache.minWithdrawalInfo.innerHTML = `৳${(appConfig.minWithdrawal || 50).toLocaleString()}`;
        elementCache.coinValueInfo.style.display = 'none'; // **পরিবর্তন: এই লাইনটি হাইড করে**
        updatePaymentMethodsUI(); 
        updateAdsLeftCount();
        elementCache.profileTotalEarned.textContent = (userData.totalEarned || 0).toLocaleString();
        elementCache.profileTasksCompleted.textContent = (userData.tasksCompleted || 0).toLocaleString();
        elementCache.profileDaysActive.textContent = (userData.daysActive || 1).toLocaleString();
        elementCache.profileReferrals.textContent = (userData.successfulReferrals || 0).toLocaleString();
        updateAdSpinsLeft();

        elementCache.referralBonusText.innerHTML = `Share your link. You both get <span class="text-accent font-bold">৳${(appConfig.referralBonus || 1).toLocaleString()}</span> as a bonus!`;
        
        const rulesList = appConfig.referralRules || [];
        elementCache.referralRulesList.innerHTML = rulesList.map(rule => `<div class="flex items-start gap-2 text-sm text-gray-300"><i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0"></i><span>${rule}</span></div>`).join('');
        lucide.createIcons({ nodes: [elementCache.referralRulesList] });

        const userReferrals = (userData.successfulReferrals || 0);
        elementCache.userReferralCount.textContent = `${userReferrals}`;
    }
    function updatePaymentMethodsUI() {
         elementCache.paymentMethodGrid.innerHTML = '';
        (appConfig.paymentMethods || []).forEach(method => {
            const card = document.createElement('div'); card.className = 'payment-method-card'; card.dataset.method = method.name;
            card.innerHTML = `<i data-lucide="${method.icon}" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i><p class="font-semibold text-sm">${method.name}</p>`;
            card.addEventListener('click', () => handlePaymentMethodSelect(method.name));
            elementCache.paymentMethodGrid.appendChild(card);
        });
        lucide.createIcons({ nodes: [elementCache.paymentMethodGrid] });
    }
    function handlePaymentMethodSelect(methodName) {
        selectedPaymentMethod = methodName;
        document.querySelectorAll('.payment-method-card').forEach(card => card.classList.toggle('selected', card.dataset.method === methodName));
        updateDynamicPaymentFields();
    }
    function updateDynamicPaymentFields() {
         if (!selectedPaymentMethod) { elementCache.paymentDetailsContainer.innerHTML = ''; return; }
        const method = selectedPaymentMethod.toLowerCase();
        let placeholder = `Enter ${selectedPaymentMethod} Details`;
        if (method.includes('upi')) placeholder = "Enter UPI ID (e.g., yourname@upi)"; else placeholder = `Enter ${selectedPaymentMethod} Number`;
        elementCache.paymentDetailsContainer.innerHTML = `<input id="payment-detail-input" type="text" placeholder="${placeholder}" class="w-full p-3 rounded-lg input-field">`;
    }
    function updateAdsLeftCount() {
        const today = new Date().toISOString().split('T')[0];
        if (userData.lastAdWatchDate !== today) userData.dailyAdCount = 0;
        const adsLeft = Math.max(0, (appConfig.dailyAdLimit || 10) - userData.dailyAdCount);
        elementCache.adsLeftCount.textContent = adsLeft;
    }

    function showMainPage(pageId) { document.querySelectorAll('.main-page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }

    function navigateTo(pageId) {
        const targetPage = document.getElementById(pageId); if (!targetPage) return;
        const isImmersive = targetPage.classList.contains('immersive-page');
        
        elementCache.mainHeader.style.display = isImmersive ? 'none' : 'flex';
        elementCache.bottomNav.classList.toggle('hidden', isImmersive);

        document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
        targetPage.classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
        
        if (pageId === 'wallet-page') loadWithdrawalHistory();
        if (pageId === 'notifications-page') loadNotifications();
        if (pageId === 'visit-page') loadVisitTasksUI();
    }
    window.navigateTo = navigateTo;

    function setupEventListeners() {
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); }));
        document.getElementById('notification-bell').addEventListener('click', () => navigateTo('notifications-page'));
        
        document.getElementById('copy-link-btn').addEventListener('click', copyReferralLink);
        document.getElementById('share-link-btn').addEventListener('click', shareReferralLink);

        document.getElementById('withdraw-btn').addEventListener('click', handleWithdrawal); 
        elementCache.freeSpinBtn.addEventListener('click', handleFreeSpin); 
        elementCache.adSpinBtn.addEventListener('click', handleAdSpin);
        
        // *** নতুন পরিবর্তন: ওয়েলকাম ডায়লগ বাটন ***
        document.getElementById('welcome-ok-btn').addEventListener('click', handleWelcomeOk);
        document.getElementById('welcome-later-btn').addEventListener('click', () => {
            document.getElementById('welcome-dialog').classList.add('hidden');
        });
    }

    // --- User Actions ---
    async function handleWithdrawal() { 
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const paymentDetailInput = document.getElementById('payment-detail-input'); const paymentDetail = paymentDetailInput ? paymentDetailInput.value.trim() : '';
        
        if (!selectedPaymentMethod) return showAlert("Please select a payment method."); 
        if (!amount || amount <= 0) return showAlert("Please enter a valid amount.");
        if (amount < appConfig.minWithdrawal) return showAlert(`Minimum withdrawal is ৳ ${appConfig.minWithdrawal.toLocaleString()}.`); 
        if (amount > userData.balance) return showAlert("Insufficient balance.");
        if (!paymentDetail) return showAlert("Please enter your payment details.");

        const userReferrals = userData.successfulReferrals || 0;
        const requiredReferrals = appConfig.minReferrals || 0;
        if (userReferrals < requiredReferrals) {
            return showAlert(`You need at least ${requiredReferrals} successful referrals to withdraw. You currently have ${userReferrals} referral.`);
        }

        elementCache.loader.style.display = 'flex';
        try {
            await updateBalance(-amount);
            await addDoc(collection(db, "withdrawals"), { userId: currentUser.uid, userName: userData.name, userEmail: userData.email, amount, method: selectedPaymentMethod, paymentDetail, status: "pending", requestedAt: serverTimestamp() });
            showAlert("Withdrawal request submitted successfully!"); document.getElementById('withdraw-amount').value = ''; paymentDetailInput.value = '';
            loadWithdrawalHistory();
        } catch (error) { showAlert("Error submitting request: " + error.message); await updateBalance(amount); } finally { elementCache.loader.style.display = 'none'; }
    }
    
    async function updateBalance(amount, updateTotalEarned = false) {
        if (!currentUser) return;
        const newBalance = (userData.balance || 0) + amount;
        const updateData = { balance: increment(amount) };

        if (updateTotalEarned && amount > 0) { 
            updateData.totalEarned = increment(amount); 
            userData.totalEarned = (userData.totalEarned || 0) + amount;
        }
        
        await updateDoc(doc(db, "users", currentUser.uid), updateData);
        userData.balance = newBalance;
        updateUI();
    }
    
    // --- Games & Tasks Logic ---
    window.claimReward = async function(taskType) {
        const today = new Date().toISOString().split('T')[0];
        const userRef = doc(db, "users", currentUser.uid);
        if (userData.lastAdWatchDate !== today) { await updateDoc(userRef, { dailyAdCount: 0, lastAdWatchDate: today }); userData.dailyAdCount = 0; userData.lastAdWatchDate = today; }
        if (userData.dailyAdCount >= appConfig.dailyAdLimit) return showAlert("You've reached your daily ad limit.");
        if (typeof window.show_10073859 !== 'function') return showAlert("Ad service not available.");
        let adPromise;
        switch(taskType) {
            case 'interstitial': adPromise = window.show_10073859(); break; case 'popup': adPromise = window.show_10073859('pop'); break; case 'inApp': adPromise = window.show_10073859({ type: 'inApp' }); break; case 'miniApp': adPromise = window.show_10073859(); break; default: return;
        }
        adPromise.then(async () => {
            const newCount = (userData.dailyAdCount || 0) + 1;
            await updateDoc(userRef, { dailyAdCount: newCount, tasksCompleted: increment(1) });
            userData.dailyAdCount = newCount; userData.tasksCompleted++;
            
            let reward = 0;
            switch(taskType) {
                case 'interstitial': reward = appConfig.rewardInterstitial || 0.5; break;
                case 'popup':       reward = appConfig.rewardPopup || 0.5; break;
                case 'inApp':       reward = appConfig.rewardInApp || 0; break;
                case 'miniApp':     reward = appConfig.rewardMiniApp || 1; break;
            }

            if (reward > 0) { 
                updateBalance(reward, true); 
                showAlert(`Congratulations! You won ৳${reward}.`); 
            }
            updateAdsLeftCount();
        }).catch(e => { showAlert('Could not show ad.'); });
    }

    // Spin Wheel Logic
    let isSpinning = false;
    const spinRewards = [1, 0.2, 0.5, 2, 0.1, 5, 0.3, 4]; // টাকাতে রিওয়ার্ড
    function initializeSpinWheelSVG() {
        const svg = document.getElementById('spin-wheel-svg');
        const colors = ['#4b5563', '#374151', '#4b5563', '#374151', '#4b5563', '#374151', '#4b5563', '#fb923c'];
        const numSegments = spinRewards.length; const angleStep = 360 / numSegments; const radius = 90; const center = 100;

        for (let i = 0; i < numSegments; i++) {
            const startAngle = i * angleStep; const endAngle = (i + 1) * angleStep;
            const start = polarToCartesian(center, center, radius, endAngle); const end = polarToCartesian(center, center, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            const d = ["M", start.x, start.y, "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y, "L", center, center, "Z"].join(" ");
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", d); path.setAttribute("fill", colors[i % colors.length]); svg.appendChild(path);

            const textAngle = startAngle + angleStep / 2;
            const textPos = polarToCartesian(center, center, radius * 0.65, textAngle);
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", textPos.x); text.setAttribute("y", textPos.y);
            text.setAttribute("transform", `rotate(${textAngle + 90}, ${textPos.x}, ${textPos.y})`);
            text.textContent = spinRewards[i]; svg.appendChild(text);
        }
    }
    function polarToCartesian(cx, cy, r, angle) { const rad = (angle - 90) * Math.PI / 180.0; return { x: cx + (r * Math.cos(rad)), y: cy + (r * Math.sin(rad)) }; }
    
    async function performSpin(isAdSpin = false) {
        if (isSpinning) return; isSpinning = true;
        const wheel = document.getElementById('wheel');
        const currentRot = (parseFloat(wheel.style.transform.replace(/rotate\(|\)|deg/g, '')) || 0) % 360;
        const randomDeg = Math.floor(Math.random() * 360);
        const totalRot = currentRot + 1800 + randomDeg;
        wheel.style.transform = `rotate(${totalRot}deg)`;
        
        elementCache.freeSpinBtn.disabled = true; 
        const adSpinBtnHtml = elementCache.adSpinBtn.innerHTML;
        elementCache.adSpinBtn.innerHTML = `Spinning...`; 
        elementCache.adSpinBtn.disabled = true;

        setTimeout(async () => {
            const finalAngle = totalRot % 360; const sectorAngle = 360 / spinRewards.length;
            const sectorIndex = Math.floor((360 - (finalAngle % 360) + sectorAngle/2) % 360 / sectorAngle);
            const reward = spinRewards[sectorIndex];
            elementCache.spinResult.textContent = `Congratulations! You won ৳${reward}!`;
            
            await updateDoc(doc(db, "users", currentUser.uid), { tasksCompleted: increment(1) }); 
            userData.tasksCompleted++;
            updateBalance(reward, true);

            if (isAdSpin) {
                await updateDoc(doc(db, "users", currentUser.uid), { adSpinsUsed: increment(1) });
                userData.adSpinsUsed++;
            }

            isSpinning = false; 
            elementCache.adSpinBtn.innerHTML = adSpinBtnHtml;
            lucide.createIcons({ nodes: [elementCache.adSpinBtn] });
            
            updateAdSpinsLeft(); 
            initializeSpinTimer();
        }, 5000);
    }
    
    async function handleFreeSpin() {
        const now = new Date();
        const lastSpin = userData.lastFreeSpin ? new Date(userData.lastFreeSpin.seconds * 1000) : null;
        if (lastSpin && (now.getTime() - lastSpin.getTime()) < (24 * 60 * 60 * 1000)) { showAlert("Next free spin not available yet."); return; }
        await updateDoc(doc(db, "users", currentUser.uid), { lastFreeSpin: serverTimestamp() });
        userData.lastFreeSpin = { seconds: Math.floor(now.getTime() / 1000) };
        performSpin(false);
    }
    
    async function checkAdSpinDate() {
        const today = new Date().toISOString().split('T')[0];
        if (userData.lastAdSpinDate !== today) {
            await updateDoc(doc(db, "users", currentUser.uid), { adSpinsUsed: 0, lastAdSpinDate: today });
            userData.adSpinsUsed = 0;
            userData.lastAdSpinDate = today;
        }
    }
    
    function updateAdSpinsLeft() {
        const today = new Date().toISOString().split('T')[0];
        let spinsUsed = userData.lastAdSpinDate !== today ? 0 : userData.adSpinsUsed || 0;
        const spinsLeft = Math.max(0, (appConfig.dailyAdSpinLimit || 5) - spinsUsed);
        elementCache.adSpinsLeft.textContent = `${spinsLeft}/${appConfig.dailyAdSpinLimit || 5}`;
        if (!isSpinning) {
            elementCache.adSpinBtn.disabled = (spinsLeft <= 0);
        }
    }

    async function handleAdSpin() {
        await checkAdSpinDate(); 
        
        const spinsLeft = (appConfig.dailyAdSpinLimit || 5) - (userData.adSpinsUsed || 0);
        if (spinsLeft <= 0) {
            return showAlert("You have used all your ad spins for today.");
        }

        if (typeof window.show_10073859 !== 'function') return showAlert("Ad service not available.");
        
        const adSpinBtnHtml = elementCache.adSpinBtn.innerHTML;
        elementCache.adSpinBtn.innerHTML = `Loading Ad...`; 
        elementCache.adSpinBtn.disabled = true;
        
        window.show_10073859().then(() => {
            performSpin(true);
        }).catch(e => {
            showAlert('Could not show ad.');
            elementCache.adSpinBtn.innerHTML = adSpinBtnHtml; 
            updateAdSpinsLeft();
            lucide.createIcons({ nodes: [elementCache.adSpinBtn] });
        });
    }

    function initializeSpinTimer() {
        const lastSpin = userData.lastFreeSpin ? new Date(userData.lastFreeSpin.seconds * 1000) : null;
        if (!lastSpin) { 
            elementCache.freeSpinBtn.disabled = isSpinning; 
            elementCache.freeSpinTimer.textContent = "Ready!"; 
            return; 
        }
        const nextSpinTime = new Date(lastSpin.getTime() + 24 * 60 * 60 * 1000);
        const timerInterval = setInterval(() => {
            const diff = nextSpinTime - new Date();
            if (diff <= 0) { 
                clearInterval(timerInterval); 
                elementCache.freeSpinBtn.disabled = isSpinning; 
                elementCache.freeSpinTimer.textContent = "Ready!"; 
                return; 
            }
            elementCache.freeSpinBtn.disabled = true;
            const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000);
            elementCache.freeSpinTimer.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }, 1000);
    }
    
    // --- Visit Task Functions ---
    function loadVisitTasksUI() {
        elementCache.visitTasksList.innerHTML = '';
        const tasks = appConfig.visitTasks || [];
        if (tasks.length === 0) {
            elementCache.visitTasksList.innerHTML = '<p class="text-gray-400 text-center">No tasks available right now.</p>';
            return;
        }

        const today = new Date().toISOString().split('T')[0];
        const completedTasks = userData.completedVisitTasks || {};

        tasks.forEach((task, index) => {
            const taskId = `visit_${index}`;
            const isCompleted = completedTasks[taskId] === today;
            
            const taskHtml = `
                <div class="card-bg p-3 rounded-lg flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-orange-500/20 rounded-full">
                            <i data-lucide="globe" class="w-6 h-6 text-accent"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-white">${task.name}</h3>
                            <p class="text-xs text-gray-400">Get ৳${task.reward}</p>
                        </div>
                    </div>
                    <button 
                        class="btn-outline-accent font-bold px-4 py-1.5 rounded-lg text-sm" 
                        ${isCompleted ? 'disabled' : ''}
                        onclick="window.processVisitTask(this, '${taskId}', '${task.link}', ${task.timer}, ${task.reward})">
                        ${isCompleted ? 'Visited' : 'Visit'}
                    </button>
                </div>
            `;
            elementCache.visitTasksList.innerHTML += taskHtml;
        });
        lucide.createIcons({ nodes: [elementCache.visitTasksList] });
    }

    // *** নতুন পরিবর্তন: ভিডিও অনুযায়ী নতুন Visit Task ফ্লো ***
    window.processVisitTask = function(buttonElement, taskId, link, timer, reward) {
        buttonElement.disabled = true;
        buttonElement.innerHTML = 'Loading Ad...';

        if (typeof window.show_10073859 !== 'function') {
             showAlert("Ad service not available.");
             buttonElement.innerHTML = 'Visit';
             buttonElement.disabled = false;
             return;
        }

        // ১. অ্যাড দেখান। এটি একটি প্রমিজ রিটার্ন করে।
        window.show_10073859()
            .then(() => {
                // ২. অ্যাড সফলভাবে বন্ধ করা হয়েছে। এখন লিংক ওপেন করুন।
                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                        window.Telegram.WebApp.openLink(link);
                    } else {
                        // টেলিগ্রামের বাইরে টেস্ট করার জন্য ফলব্যাক
                        window.open(link, '_blank');
                    }
                } catch (e) {
                    console.error("Failed to open link: ", e);
                    showAlert("Failed to open link.");
                }

                // ৩. লিংক ওপেন করার সাথে সাথেই টাইমার শুরু করুন
                let remaining = timer;
                buttonElement.innerHTML = `Wait ${remaining}s`;

                const timerInterval = setInterval(async () => {
                    remaining--;
                    if (remaining > 0) {
                        buttonElement.innerHTML = `Wait ${remaining}s`;
                    } else {
                        // ৪. টাইমার শেষ। रिवॉर्ड দিন।
                        clearInterval(timerInterval);
                        buttonElement.innerHTML = 'Visited';
                        
                        const today = new Date().toISOString().split('T')[0];
                        const updateData = { tasksCompleted: increment(1) };
                        // ডট নোটেশন ব্যবহার করে Firestore-এ নির্দিষ্ট টাস্ক আপডেট করুন
                        updateData[`completedVisitTasks.${taskId}`] = today;

                        await updateDoc(doc(db, "users", currentUser.uid), updateData);
                        
                        // লোকাল ইউজার ডেটাও সিঙ্ক করুন
                        if (!userData.completedVisitTasks) userData.completedVisitTasks = {};
                        userData.completedVisitTasks[taskId] = today;
                        userData.tasksCompleted++;

                        // ব্যালেন্স এবং UI আপডেট করুন
                        await updateBalance(reward, true);
                        showAlert(`Congratulations! You earned ৳${reward}!`);
                    }
                }, 1000);

            })
            .catch((error) => {
                // অ্যাড লোড ফেইল হলে বা স্কিপ করা হলে
                console.error("Ad or Task Error: ", error);
                showAlert("Ad failed to load. Please try again.");
                buttonElement.innerHTML = 'Visit';
                buttonElement.disabled = false;
            });
    }

    // --- Utility & Helper Functions ---

    const BOT_USERNAME = "PixelPayv_bot"; // ⚠️⚠️⚠️ এখানে আপনার বটের ইউজারনেম দিন ⚠️⚠️⚠️

    function getReferralLink() {
        if (!currentUser) return null;
        return `https://t.me/${BOT_USERNAME}/app?startapp=${currentUser.uid}`;
    }

    function copyReferralLink() {
        const link = getReferralLink();
        if (!link) return showAlert("Could not generate link.");

        const shareTemplate = appConfig.shareText || "Join me on CashReward! {APP_LINK}";
        const userCode = userData.referralCode || currentUser.uid;
        
        const textToCopy = shareTemplate
            .replace(/{APP_LINK}/g, link)
            .replace(/{CODE}/g, userCode);
        
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => showAlert("Referral info copied!"));
        } else {
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert("Referral info copied!");
            } catch (err) {
                showAlert("Failed to copy link.");
            }
            document.body.removeChild(textArea);
        }
    }
    
    function shareReferralLink() {
        const link = getReferralLink();
        if (!link) return showAlert("Could not generate link.");
        
        const shareTemplate = appConfig.shareText || "Join me on CashReward! {APP_LINK}";
        const userCode = userData.referralCode || currentUser.uid;
        
        const text = shareTemplate
            .replace(/{APP_LINK}/g, link)
            .replace(/{CODE}/g, userCode);

        if (navigator.share) {
            navigator.share({
                title: 'Join CashReward!',
                text: text
            });
        } else {
            copyReferralLink();
            showAlert("Share feature not available. Info copied instead!");
        }
    }
    
    async function checkNewNotifications() {
        const lastCheck = userData.lastNotificationCheck; if (!lastCheck || !lastCheck.seconds) return;
        const q = query(collection(db, "notifications"), where("createdAt", ">", lastCheck), limit(1));
        const snap = await getDocs(q); elementCache.notificationDot.style.display = snap.empty ? 'none' : 'block';
    }
    async function loadNotifications() {
        const listEl = document.getElementById('notifications-list'); listEl.innerHTML = '<p class="text-gray-400">Loading...</p>';
        elementCache.notificationDot.style.display = 'none';
        const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
        try {
            const snap = await getDocs(q);
            if (snap.empty) { listEl.innerHTML = '<p class="text-gray-400 text-center">No notifications.</p>'; return; }
            listEl.innerHTML = snap.docs.map(doc => {
                const msg = doc.data(); const date = msg.createdAt ? msg.createdAt.toDate().toLocaleDateString() : '';
                return `<div class="card-bg p-4 rounded-lg"><div class="flex justify-between items-center mb-1"><h3 class="font-bold text-white">${msg.title}</h3><p class="text-xs text-gray-400">${date}</p></div><p class="text-sm text-gray-300">${msg.message}</p></div>`;
            }).join('');
            await updateDoc(doc(db, "users", currentUser.uid), { lastNotificationCheck: serverTimestamp() });
        } catch (error) { listEl.innerHTML = '<p class="text-red-400">Error loading notifications.</p>'; }
    }

    async function loadWithdrawalHistory() {
        const listEl = document.getElementById('withdrawal-history-list'); listEl.innerHTML = '<p class="text-gray-400 text-center py-4">Loading history...</p>';
        
        const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid));
        
        try {
            const snap = await getDocs(q);
            if (snap.empty) { listEl.innerHTML = '<p class="text-gray-400 text-center py-4">No withdrawal history found.</p>'; return; }
            
            const docs = snap.docs.map(doc => doc.data());
            docs.sort((a, b) => {
                const timeA = a.requestedAt?.seconds || 0;
                const timeB = b.requestedAt?.seconds || 0;
                return timeB - timeA;
            });

            listEl.innerHTML = docs.map(req => {
                const statusInfo = { pending: {c:'yellow',i:'hourglass'}, approved:{c:'green',i:'check-circle-2'}, rejected:{c:'red',i:'x-circle'} }[req.status] || {c:'gray',i:'help-circle'};
                const date = req.requestedAt ? req.requestedAt.toDate().toLocaleDateString() : '';
                return `<div class="card-bg p-3 rounded-lg flex items-center justify-between"><div class="flex items-center gap-3"><div class="p-2 bg-${statusInfo.c}-500/20 rounded-full"><i data-lucide="${statusInfo.i}" class="w-5 h-5 text-${statusInfo.c}-400"></i></div><div><p class="font-semibold text-white">৳${req.amount.toLocaleString()} - ${req.method}</p><p class="text-xs text-gray-400">${date}</p></div></div><p class="font-semibold text-sm text-${statusInfo.c}-400 capitalize">${req.status}</p></div>`;
            }).join('');
            lucide.createIcons({ nodes: [listEl] });
        } catch (error) { 
            console.error(error); 
            listEl.innerHTML = '<p class="text-red-400 text-center py-4">Error loading history.<br><span class="text-xs">Please ensure the Firestore index is created.</span></p>'; 
        }
    }

    function showAlert(message) {
        document.getElementById('alert-message').textContent = message;
        document.getElementById('custom-alert').classList.remove('hidden');
        document.getElementById('alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
    }
    
    // *** নতুন পরিবর্তন: ওয়েলকাম ডায়লগ ফাংশন ***
    function showWelcomeDialog(title, message) {
        document.getElementById('welcome-title-text').textContent = title;
        document.getElementById('welcome-message-text').textContent = message;
        document.getElementById('welcome-dialog').classList.remove('hidden');
    }

    async function handleWelcomeOk() {
        document.getElementById('welcome-dialog').classList.add('hidden');
        const newVersion = appConfig.welcomeVersion || 1;
        try {
            await updateDoc(doc(db, "users", currentUser.uid), { lastSeenWelcomeVersion: newVersion });
            userData.lastSeenWelcomeVersion = newVersion; // Update local state
        } catch (e) {
            console.error("Failed to update welcome version: ", e);
        }
    }
</script>
</body>
</html>
